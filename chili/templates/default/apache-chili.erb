<% chili = node[:chili] -%>
<VirtualHost *:80>
  ServerName <%= chili[:server_names].join(" ") %>
<% if chili[:server_aliases] -%>
  ServerAlias <%= chili[:server_aliases].join(" ") %>
<% end -%>

  DocumentRoot <%= chili[:site_dir] %>/public

  RewriteEngine On

  <Proxy balancer://chili>
    BalancerMember http://127.0.0.1:<%= chili[:unicorn_port] %>
  </Proxy>

  RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
  RewriteRule ^/(.*)$ balancer://chili%{REQUEST_URI} [P,QSA,L]

  ProxyPass / balancer://chili/
  ProxyPassReverse / balancer://chili/
  ProxyPreserveHost on

  <Proxy *>
    Order deny,allow
    Allow from all
  </Proxy>

  # Custom log file locations
  ErrorLog  <%= chili[:log_dir] %>/error.log
  CustomLog <%= chili[:log_dir] %>/access.log combined

</VirtualHost>
