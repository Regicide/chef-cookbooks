# See http://unicorn.bogomips.org/Unicorn/Configurator.html for complete
# documentation.
worker_processes 2

working_directory "<%= node[:chili][:site_dir] %>" # available in 0.94.0+

<%
case node[:chili][:web_server]
when "nginx"
-%>
listen "<%= node[:chili][:temp_dir] %>/sockets/chili.socket", :backlog => 64

<% when "apache" -%>
listen "127.0.0.1:<%= node[:chili][:unicorn_port] %>", :tcp_nopush => true
<% end -%>

timeout 30

pid "<%= node[:chili][:temp_dir] %>/pids/unicorn.pid"

stderr_path "<%= node[:chili][:log_dir] %>/unicorn.stderr.log"
stdout_path "<%= node[:chili][:log_dir] %>/unicorn.stdout.log"

preload_app true
GC.respond_to?(:copy_on_write_friendly=) and
  GC.copy_on_write_friendly = true

check_client_connection false

before_fork do |server, worker|
  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.connection.disconnect!

  old_pid = "#{server.config[:pid]}.oldbin"
  if old_pid != server.pid
    begin
      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU
      Process.kill(sig, File.read(old_pid).to_i)
      rescue Errno::ENOENT, Errno::ESRCH
    end
  end

end

after_fork do |server, worker|

  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.establish_connection

end
